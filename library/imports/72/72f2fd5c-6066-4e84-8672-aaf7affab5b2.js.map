{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\common\\script/assets\\common\\script\\uiRoom.js"],"names":["uiPanel","require","mvs","GLB","cc","Class","extends","properties","onLoad","_super","players","roomId","roomInfo","owner","playerPrefab","nodeDict","active","on","quit","startGame","clientEvent","eventType","joinRoomNotify","leaveRoomResponse","leaveRoomNotify","kickPlayerResponse","kickPlayerNotify","i","MAX_PLAYER_COUNT","temp","instantiate","parent","roomUserInfo","getComponent","init","push","data","j","length","userId","kickPlayerRsp","userID","userInfo","id","isRoomOwner","uiFunc","closeUI","node","name","destroy","setData","ownerId","leaveRoomRsp","status","console","log","leaveRoomInfo","refreshStartBtn","spNode","btn","Button","color","Color","WHITE","enabled","BLACK","engine","leaveRoom","openUI","obj","uiTip","bind","userIds","playerCnt","result","joinOver","playerUserIds","msg","action","GAME_START_EVENT","Game","GameManager","sendEventEx","createRoomInit","rsp","roomID","joinRoomInit","roomUserInfoList","sort","a","b","onDestroy","off"],"mappings":"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","file":"uiRoom.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\common\\script","sourcesContent":["var uiPanel = require(\"uiPanel\");\r\nvar mvs = require(\"Matchvs\");\r\nvar GLB = require(\"Glb\");\r\ncc.Class({\r\n    extends: uiPanel,\r\n    properties: {},\r\n\r\n    onLoad() {\r\n        this._super();\r\n        this.players = [];\r\n        this.roomId = 0;\r\n        this.roomInfo = null;\r\n        this.owner = 0;\r\n        this.playerPrefab = this.nodeDict[\"player\"];\r\n        this.playerPrefab.active = false;\r\n        this.nodeDict[\"quit\"].on(\"click\", this.quit, this);\r\n        this.nodeDict[\"startGame\"].on(\"click\", this.startGame, this);\r\n\r\n\r\n        clientEvent.on(clientEvent.eventType.joinRoomNotify, this.joinRoomNotify, this);\r\n        clientEvent.on(clientEvent.eventType.leaveRoomResponse, this.leaveRoomResponse, this);\r\n        clientEvent.on(clientEvent.eventType.leaveRoomNotify, this.leaveRoomNotify, this);\r\n        clientEvent.on(clientEvent.eventType.kickPlayerResponse, this.kickPlayerResponse, this);\r\n        clientEvent.on(clientEvent.eventType.kickPlayerNotify, this.kickPlayerNotify, this);\r\n\r\n        for (var i = 0; i < GLB.MAX_PLAYER_COUNT; i++) {\r\n            var temp = cc.instantiate(this.playerPrefab);\r\n            temp.active = true;\r\n            temp.parent = this.nodeDict[\"layout\"];\r\n            var roomUserInfo = temp.getComponent('roomUserInfo');\r\n            roomUserInfo.init();\r\n            this.players.push(roomUserInfo);\r\n        }\r\n    },\r\n\r\n    kickPlayerResponse: function(data) {\r\n        for (var j = 0; j < this.players.length; j++) {\r\n            if (this.players[j].userId === data.kickPlayerRsp.userID) {\r\n                this.players[j].init();\r\n                break;\r\n            }\r\n        }\r\n        if (GLB.userInfo.id === data.kickPlayerRsp.userID) {\r\n            GLB.isRoomOwner = false;\r\n            uiFunc.closeUI(this.node.name);\r\n            this.node.destroy();\r\n        }\r\n    },\r\n\r\n    kickPlayerNotify: function(data) {\r\n        for (var j = 0; j < this.players.length; j++) {\r\n            if (this.players[j].userId === data.kickPlayerNotify.userId) {\r\n                this.players[j].init();\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (GLB.userInfo.id === data.kickPlayerNotify.userId) {\r\n            GLB.isRoomOwner = false;\r\n            uiFunc.closeUI(this.node.name);\r\n            this.node.destroy();\r\n        }\r\n    },\r\n\r\n    joinRoomNotify: function(data) {\r\n        for (var j = 0; j < this.players.length; j++) {\r\n            if (this.players[j].userId === 0) {\r\n                this.players[j].setData(data.roomUserInfo.userId, this.ownerId);\r\n                break;\r\n            }\r\n        }\r\n    },\r\n\r\n    leaveRoomResponse: function(data) {\r\n        if (data.leaveRoomRsp.status === 200) {\r\n            console.log(\"离开房间成功！\");\r\n        } else {\r\n            console.log(\"离开房间失败\");\r\n        }\r\n        GLB.isRoomOwner = false;\r\n        uiFunc.closeUI(this.node.name);\r\n        this.node.destroy();\r\n    },\r\n\r\n    leaveRoomNotify: function(data) {\r\n        for (var j = 0; j < this.players.length; j++) {\r\n            if (this.players[j].userId === data.leaveRoomInfo.userId) {\r\n                this.players[j].init();\r\n                break;\r\n            }\r\n        }\r\n        this.ownerId = data.leaveRoomInfo.owner;\r\n        if (this.ownerId === GLB.userInfo.id) {\r\n            GLB.isRoomOwner = true;\r\n        }\r\n        for (var i = 0; i < this.players.length; i++) {\r\n            if (this.players[i].userId !== 0) {\r\n                this.players[i].setData(this.players[i].userId, this.ownerId);\r\n            }\r\n        }\r\n        this.refreshStartBtn();\r\n    },\r\n\r\n    refreshStartBtn() {\r\n        var spNode = this.nodeDict[\"startGame\"];\r\n        var btn = this.nodeDict[\"startGame\"].getComponent(cc.Button);\r\n        if (GLB.isRoomOwner) {\r\n            spNode.color = cc.Color.WHITE;\r\n            btn.enabled = true;\r\n        }else{\r\n            spNode.color = cc.Color.BLACK;\r\n            btn.enabled = false;\r\n        }\r\n    },\r\n\r\n    quit: function() {\r\n        mvs.engine.leaveRoom(\"\");\r\n    },\r\n\r\n    startGame: function() {\r\n        if (!GLB.isRoomOwner) {\r\n            uiFunc.openUI(\"uiTip\", function(obj) {\r\n                var uiTip = obj.getComponent(\"uiTip\");\r\n                if (uiTip) {\r\n                    uiTip.setData(\"等待房主开始游戏\");\r\n                }\r\n            }.bind(this));\r\n            return;\r\n        }\r\n        var userIds = [];\r\n        var playerCnt = 0;\r\n        for (var j = 0; j < this.players.length; j++) {\r\n            if (this.players[j].userId !== 0) {\r\n                playerCnt++;\r\n                userIds.push(this.players[j].userId);\r\n            }\r\n        }\r\n\r\n        if (playerCnt === GLB.MAX_PLAYER_COUNT) {\r\n            var result = mvs.engine.joinOver(\"\");\r\n            console.log(\"发出关闭房间的通知\");\r\n            if (result !== 0) {\r\n                console.log(\"关闭房间失败，错误码：\", result);\r\n            }\r\n\r\n            GLB.playerUserIds = userIds;\r\n\r\n            var msg = {\r\n                action: GLB.GAME_START_EVENT,\r\n                userIds: userIds\r\n            };\r\n            Game.GameManager.sendEventEx(msg);\r\n        } else {\r\n            uiFunc.openUI(\"uiTip\", function(obj) {\r\n                var uiTip = obj.getComponent(\"uiTip\");\r\n                if (uiTip) {\r\n                    uiTip.setData(\"房间人数不足\");\r\n                }\r\n            }.bind(this));\r\n        }\r\n    },\r\n\r\n    createRoomInit(rsp) {\r\n        this.roomId = rsp.roomID;\r\n        this.ownerId = rsp.owner;\r\n        this.players[0].setData(this.ownerId, this.ownerId);\r\n        GLB.isRoomOwner = true;\r\n        this.refreshStartBtn();\r\n    },\r\n\r\n    joinRoomInit(roomUserInfoList, roomInfo) {\r\n        roomUserInfoList.sort(function(a, b) {\r\n            if (roomInfo.ownerId === b.userId) {\r\n                return 1;\r\n            }\r\n            return 0;\r\n        });\r\n        this.ownerId = roomInfo.ownerId;\r\n        for (var j = 0; j < roomUserInfoList.length; j++) {\r\n            this.players[j].setData(roomUserInfoList[j].userId, this.ownerId);\r\n        }\r\n        this.refreshStartBtn();\r\n    },\r\n\r\n    onDestroy() {\r\n        clientEvent.off(clientEvent.eventType.joinRoomNotify, this.joinRoomNotify, this);\r\n        clientEvent.off(clientEvent.eventType.leaveRoomResponse, this.leaveRoomResponse, this);\r\n        clientEvent.off(clientEvent.eventType.leaveRoomNotify, this.leaveRoomNotify, this);\r\n        clientEvent.off(clientEvent.eventType.kickPlayerResponse, this.kickPlayerResponse, this);\r\n        clientEvent.off(clientEvent.eventType.kickPlayerNotify, this.kickPlayerNotify, this);\r\n    }\r\n});\r\n"]}